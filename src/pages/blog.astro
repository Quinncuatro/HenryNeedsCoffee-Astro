---
import TerminalLayout from '../layouts/TerminalLayout.astro';
import { getCollection } from 'astro:content';

// Get all blog posts
const blogPosts = await getCollection('blog');

// Sort posts by date (newest first)
const sortedPosts = blogPosts.sort(
  (a, b) => new Date(b.data.date).valueOf() - new Date(a.data.date).valueOf()
);

// Function to strip markdown syntax and truncate at a whole word
function createExcerpt(text, maxLength = 280) {
  // Remove markdown headings, links, images, code blocks, etc.
  const strippedText = text
    .replace(/^#+\s+/gm, '') // Remove headings
    .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1') // Replace markdown links with just the text
    .replace(/!\[[^\]]*\]\([^)]+\)/g, '') // Remove images
    .replace(/`{1,3}[^`]+`{1,3}/g, '') // Remove inline code
    .replace(/```[\s\S]*?```/g, '') // Remove code blocks
    .replace(/^\s*[-*+]\s+/gm, '') // Remove list markers
    .replace(/^\s*\d+\.\s+/gm, '') // Remove numbered list markers
    .replace(/(\*\*|__)(.*?)\1/g, '$2') // Replace bold with just the text
    .replace(/(\*|_)(.*?)\1/g, '$2'); // Replace italic with just the text

  // Truncate to maxLength and ensure ending at a whole word
  if (strippedText.length <= maxLength) {
    return strippedText;
  }

  const truncated = strippedText.substring(0, maxLength);
  // Find the last space to truncate at a whole word
  const lastSpace = truncated.lastIndexOf(' ');

  if (lastSpace > 0) {
    return truncated.substring(0, lastSpace) + '…';
  }

  return truncated + '…';
}
---

<TerminalLayout
  title="Blog"
  activeNav="blog"
  commandPrompt="ls blog/"
  typingSpeed={10}>
      <h1>Recent Articles</h1>
      <hr />

      <div class="blog-posts">
        {sortedPosts.map((post) => (
          <article class="post-item">
            <h2><a href={`/blog/${post.slug}`}>{post.data.title}</a></h2>
            <p class="post-date">{new Date(post.data.date).toLocaleDateString('en-us', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
            {post.data.category && (
              <div class="post-category">{post.data.category}</div>
            )}
            <p class="post-excerpt">{createExcerpt(post.body)}</p>
          </article>
        ))}
      </div>
</TerminalLayout>
<style>
  .blog-posts {
    margin-top: 30px;
  }

  .post-item {
    margin-bottom: 40px;
    padding-bottom: 20px;
    border-bottom: 1px solid #ddd;
  }

  .post-item h2 {
    margin-bottom: 8px;
  }

  .post-item h2 a {
    color: var(--link-color);
    text-decoration: none;
  }

  .post-item h2 a:hover {
    color: var(--link-hover);
    text-decoration: none;
  }

  .post-date {
    color: #777;
    font-size: 0.9rem;
    margin-bottom: 10px;
  }

  .post-category {
    display: inline-block;
    background-color: var(--accent-color);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    margin-bottom: 10px;
  }

  .post-excerpt {
    line-height: 1.5;
    color: var(--text-color);
  }

  .read-more {
    display: inline-block;
    margin-top: 10px;
    color: var(--accent-color);
    font-weight: bold;
  }
</style>